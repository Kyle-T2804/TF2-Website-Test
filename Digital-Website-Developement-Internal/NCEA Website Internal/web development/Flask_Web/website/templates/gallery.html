{% extends "template.html" %}
{% block title %}Gallery | TF2 Mercenary Database{% endblock %}

{% block head %}
<style>
  /* Hero */
  .gallery-hero {
    background: linear-gradient(90deg,#ffc857 0%,#a73232 100%);
    color:#fff; border-radius:18px; padding:1.25rem 1.5rem; margin-top:1.5rem;
  }
  .gallery-hero h2 { margin:0; font-weight:800; letter-spacing:.2px; }
  .gallery-hero .sub { opacity:.9; }

  /* Upload card */
  .upload-card { border:0; border-radius:18px; overflow:hidden; }
  .drop-zone {
    border:2px dashed rgba(0,0,0,.2);
    border-radius:14px; padding:1rem; text-align:center;
    transition: border-color .2s ease, background .2s ease;
    background: #fff;
  }
  .drop-zone.dragover { border-color:#a73232; background: #fff6e0; }
  .drop-zone .hint { color:#666; }
  .preview {
    display:none; margin-top:.75rem; gap:.75rem; align-items:center; text-align:left;
  }
  .preview img { width:56px; height:56px; object-fit:cover; border-radius:8px; }
  .preview .meta { font-size:.9rem; color:#444; }
  .theme-dark .drop-zone { background:#1f1f1f; border-color:rgba(255,255,255,.15); }
  .theme-dark .drop-zone.dragover { background:#2a2a2a; }
  .theme-dark .preview .meta { color:#d6d6d6; }

  /* Controls row */
  .controls { display:flex; gap:.75rem; align-items:center; flex-wrap:wrap; margin:1rem 0; }
  .controls .search { flex:1 1 280px; }

  /* Masonry grid (CSS columns) */
  .gallery-grid { column-count: 3; column-gap: 1rem; }
  @media (max-width: 992px){ .gallery-grid { column-count: 2; } }
  @media (max-width: 576px){ .gallery-grid { column-count: 1; } }

  .gallery-card {
    break-inside: avoid; margin: 0 0 1rem; border-radius:14px; overflow:hidden;
    box-shadow: 0 6px 18px rgba(0,0,0,.08);
    background:#fff; border:1px solid rgba(0,0,0,.06);
    transition: transform .12s ease, box-shadow .12s ease;
  }
  .gallery-card:hover { transform: translateY(-3px); box-shadow:0 10px 24px rgba(0,0,0,.12); }
  .gallery-img { width:100%; display:block; height:auto; }
  .gallery-body { padding:.75rem .9rem; }
  .gallery-title { margin:0 0 .35rem; font-size:.95rem; font-weight:700; }
  .gallery-meta { font-size:.85rem; color:#666; }

  .theme-dark .gallery-card { background:#1b1b1b; border-color:rgba(255,255,255,.08); box-shadow:0 6px 18px rgba(0,0,0,.45); }
  .theme-dark .gallery-meta { color:rgba(255,255,255,.75); }

  /* Lightbox modal */
  .lightbox-img { max-height: 70vh; object-fit: contain; }
  .lightbox-caption { font-size:.95rem; color:#444; }
  .theme-dark .lightbox-caption { color:#e9e9e9; }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <!-- Hero -->
  <div class="gallery-hero">
    <h2 class="mb-1"><i class="fa-solid fa-images me-2"></i>Gallery</h2>
    <div class="sub">Upload, browse, and view community screenshots.</div>
  </div>

  <div class="row justify-content-center mt-4">
    <div class="col-lg-10 col-xl-9">
      {% include "_flash.html" %}

      <!-- Upload -->
      <div class="card upload-card shadow-sm mb-4">
        <div class="card-body">
          <form method="POST" enctype="multipart/form-data" id="uploadForm">
            <div class="drop-zone" id="dropZone">
              <div class="mb-2">
                <i class="fa-solid fa-cloud-arrow-up fa-2x mb-1" aria-hidden="true"></i>
                <div class="fw-bold">Drag & drop images here</div>
                <div class="hint">or click to select (max 5 MB)</div>
              </div>
              <input type="file" id="image" name="image" class="form-control d-none" accept="image/*" required>
              <div class="preview" id="preview">
                <img id="previewImg" alt="Preview">
                <div class="meta">
                  <div class="fw-semibold" id="previewName"></div>
                  <div class="text-muted" id="previewSize"></div>
                </div>
              </div>
            </div>

            <div class="row g-2 align-items-end mt-3">
              <div class="col-md-8">
                <label for="description" class="form-label">Description (optional)</label>
                <input type="text" id="description" name="description" class="form-control" maxlength="250" placeholder="Say something about your image...">
              </div>
              <div class="col-md-4 text-md-end">
                <button class="btn btn-primary w-100" type="submit" id="uploadBtn" disabled>
                  <i class="fa-solid fa-upload me-1"></i> Upload
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>

      <!-- Controls -->
      <div class="controls">
        <div class="search input-group">
          <span class="input-group-text"><i class="fa-solid fa-magnifying-glass"></i></span>
          <input type="search" id="searchInput" class="form-control" placeholder="Search by description or uploader...">
        </div>
        <div class="btn-group" role="group" aria-label="Sort">
          <button type="button" class="btn btn-outline-secondary active" data-sort="new">New</button>
          <button type="button" class="btn btn-outline-secondary" data-sort="alpha">A–Z</button>
        </div>
      </div>

      <!-- Grid -->
      <div id="galleryGrid" class="gallery-grid">
        {% for img in images %}
        <article
          class="gallery-card"
          data-desc="{{ (img.description or '')|e }}"
          data-uploader="{{ img.uploader.username|e }}"
          data-date="{{ img.nzst|e }}"
          data-index="{{ loop.index0 }}"
        >
          <img
            class="gallery-img"
            src="{{ url_for('static', filename='gallery/' ~ img.filename) }}"
            alt="{{ img.description or 'User image' }}"
            loading="lazy"
            decoding="async"
            data-full="{{ url_for('static', filename='gallery/' ~ img.filename) }}"
          >
          <div class="gallery-body">
            <h6 class="gallery-title">{{ img.description or "No description" }}</h6>
            <div class="gallery-meta">
              <strong>By:</strong> {{ img.uploader.username }}
              &nbsp;•&nbsp;
              <strong>Date:</strong> {{ img.nzst }}
            </div>
          </div>
        </article>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Lightbox Modal -->
  <div class="modal fade" id="lightbox" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="fa-regular fa-image me-2"></i>
            Image Viewer
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body text-center">
          <img id="lightboxImg" class="img-fluid lightbox-img" alt="">
          <div class="mt-3 lightbox-caption text-start">
            <div id="lbDesc" class="fw-semibold"></div>
            <div class="text-muted"><span id="lbUploader"></span> • <span id="lbDate"></span></div>
          </div>
        </div>
        <div class="modal-footer justify-content-between">
          <div class="btn-group">
            <button class="btn btn-outline-secondary" id="prevBtn"><i class="fa-solid fa-arrow-left"></i></button>
            <button class="btn btn-outline-secondary" id="nextBtn"><i class="fa-solid fa-arrow-right"></i></button>
          </div>
          <div class="btn-group">
            <a id="downloadBtn" class="btn btn-primary" download><i class="fa-solid fa-download me-1"></i>Download</a>
            <button class="btn btn-outline-secondary" id="copyLinkBtn"><i class="fa-solid fa-link me-1"></i>Copy link</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block javascript %}
<script>
  // Drag & drop + preview
  (function(){
    const dz = document.getElementById('dropZone');
    const input = document.getElementById('image');
    const btn = document.getElementById('uploadBtn');
    const preview = document.getElementById('preview');
    const pImg = document.getElementById('previewImg');
    const pName = document.getElementById('previewName');
    const pSize = document.getElementById('previewSize');
    const MAX = 5 * 1024 * 1024;

    function formatBytes(b){ if(b<1024) return b+' B'; if(b<1048576) return (b/1024).toFixed(1)+' KB'; return (b/1048576).toFixed(1)+' MB'; }
    function setFile(file){
      if(!file) { btn.disabled = true; preview.style.display='none'; return; }
      if(!file.type.startsWith('image/')) { alert('Please select an image.'); input.value=''; btn.disabled=true; return; }
      if(file.size > MAX) { alert('Image exceeds 5 MB.'); input.value=''; btn.disabled=true; return; }
      btn.disabled = false;
      pName.textContent = file.name;
      pSize.textContent = formatBytes(file.size);
      const url = URL.createObjectURL(file);
      pImg.src = url;
      preview.style.display='flex';
    }

    dz.addEventListener('click', () => input.click());
    dz.addEventListener('dragover', (e) => { e.preventDefault(); dz.classList.add('dragover'); });
    dz.addEventListener('dragleave', () => dz.classList.remove('dragover'));
    dz.addEventListener('drop', (e) => {
      e.preventDefault(); dz.classList.remove('dragover');
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      if (f) { input.files = e.dataTransfer.files; setFile(f); }
    });
    input.addEventListener('change', () => setFile(input.files[0]));
  })();

  // Search/filter
  (function(){
    const q = document.getElementById('searchInput');
    const grid = document.getElementById('galleryGrid');
    if(!q || !grid) return;
    function filter(){
      const v = (q.value || '').toLowerCase();
      grid.querySelectorAll('.gallery-card').forEach(card => {
        const hay = (card.dataset.desc + ' ' + card.dataset.uploader).toLowerCase();
        card.style.display = hay.includes(v) ? '' : 'none';
      });
    }
    q.addEventListener('input', filter);
  })();

  // Sort
  (function(){
    const grid = document.getElementById('galleryGrid');
    const group = document.querySelector('.btn-group[role="group"]');
    if(!grid || !group) return;
    group.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-sort]');
      if(!btn) return;
      group.querySelectorAll('button').forEach(b=>b.classList.toggle('active', b===btn));
      const mode = btn.dataset.sort;
      const items = Array.from(grid.children);
      if (mode === 'alpha') {
        items.sort((a,b)=> (a.dataset.desc || '').localeCompare(b.dataset.desc || ''));
      } else {
        items.sort((a,b)=> (b.dataset.index|0) - (a.dataset.index|0)); // New first
      }
      items.forEach(n=>grid.appendChild(n));
    });
  })();

  // Lightbox
  (function(){
    const modalEl = document.getElementById('lightbox');
    const imgEl = document.getElementById('lightboxImg');
    const descEl = document.getElementById('lbDesc');
    const upEl = document.getElementById('lbUploader');
    const dateEl = document.getElementById('lbDate');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const dlBtn = document.getElementById('downloadBtn');
    const copyBtn = document.getElementById('copyLinkBtn');
    const gallery = Array.from(document.querySelectorAll('.gallery-card'));
    if(!modalEl) return;
    const bsModal = new bootstrap.Modal(modalEl);
    let idx = 0;

    function show(i){
      idx = (i + gallery.length) % gallery.length;
      const card = gallery[idx];
      const full = card.querySelector('img').dataset.full;
      const alt = card.querySelector('img').getAttribute('alt') || 'Image';
      const desc = card.dataset.desc || 'No description';
      const uploader = card.dataset.uploader || 'Unknown';
      const date = card.dataset.date || '';
      imgEl.src = full;
      imgEl.alt = alt;
      descEl.textContent = desc;
      upEl.textContent = 'By ' + uploader;
      dateEl.textContent = date;
      dlBtn.href = full;
      history.replaceState(null, '', '#img-' + idx);
    }

    document.getElementById('galleryGrid')?.addEventListener('click', (e)=>{
      const img = e.target.closest('img.gallery-img'); if(!img) return;
      const card = img.closest('.gallery-card');
      const i = gallery.indexOf(card);
      if (i >= 0) { show(i); bsModal.show(); }
    });

    prevBtn.addEventListener('click', ()=> show(idx-1));
    nextBtn.addEventListener('click', ()=> show(idx+1));
    modalEl.addEventListener('keydown', (e)=> {
      if (e.key === 'ArrowLeft') show(idx-1);
      if (e.key === 'ArrowRight') show(idx+1);
    }, true);

    copyBtn.addEventListener('click', async ()=>{
      try {
        await navigator.clipboard.writeText(window.location.origin + document.getElementById('lightboxImg').src.replace(window.location.origin,''));
        copyBtn.innerHTML = '<i class="fa-solid fa-check me-1"></i>Copied';
        setTimeout(()=> copyBtn.innerHTML = '<i class="fa-solid fa-link me-1"></i>Copy link', 1200);
      } catch(_) {}
    });

    // Deep-link via hash (#img-<index>)
    if (location.hash.startsWith('#img-')) {
      const n = parseInt(location.hash.replace('#img-',''), 10);
      if (!Number.isNaN(n) && n >= 0 && n < gallery.length) { show(n); bsModal.show(); }
    }
  })();
</script>
{% endblock %}