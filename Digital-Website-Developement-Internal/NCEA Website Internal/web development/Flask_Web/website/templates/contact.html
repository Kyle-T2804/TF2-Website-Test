{% extends "template.html" %}
{% block title %}Contact | TF2 Mercenary Database{% endblock %}

{% block head %}
<style>
body {
  background: linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 60%, var(--bg3) 100%);
  color: var(--text);
}

/* Top bar */
.forum-topbar{ display:flex; align-items:center; gap:.8rem; padding:.75rem .5rem 0; flex-wrap:wrap; }
.forum-search {
  flex: 1;
  background: var(--surface);
  border: 1px solid var(--border);
  color: var(--text);
  border-radius: 10px;
  padding: .7rem 1rem;
  outline: 0;
  transition: all 0.2s ease;
}
.forum-search::placeholder {
  color: #9aa1ad;
  transition: color 0.2s ease;
}
.forum-search:hover:not(:focus) {
  border-color: color-mix(in srgb, var(--accent-2) 50%, var(--border));
}
.forum-search:focus {
  border-color: var(--accent-2);
  box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent-2) 25%, transparent);
  background: var(--surface-2);
}
.forum-search:focus::placeholder {
  color: #bbc1cc;
}
.forum-new-btn{ background:linear-gradient(90deg,var(--accent-2),var(--accent)); color:#1b1b1b; font-weight:800; border:0; border-radius:10px; padding:.65rem 1.1rem; box-shadow:0 4px 18px rgba(0,0,0,.18); }
.forum-new-btn:hover{ filter:brightness(1.08); transform:translateY(-2px); box-shadow:0 6px 20px rgba(0,0,0,.25); }
.forum-new-btn:active { transform: translateY(0); filter: brightness(0.95); box-shadow: 0 2px 8px rgba(0,0,0,.15); }

/* Filters + sort */
.forum-controls{ display:flex; gap:.6rem; align-items:center; padding:.6rem .5rem 1rem; flex-wrap:wrap; }
.forum-filter{ background:var(--surface); color:var(--accent-2); border-radius:999px; padding:.25rem .9rem; font-weight:700; font-size:.92rem; border:1px solid var(--border); cursor:pointer; transition: all 0.2s ease; }
.forum-filter:hover:not(.active) {
  background: var(--surface-2);
  border-color: var(--accent-2);
  transform: translateY(-1px);
}
.forum-filter.active, .forum-filter:active {
  background: var(--accent-2);
  color: var(--accent);
  border-color: var(--accent-2);
  transform: translateY(0);
}

/* Grid + cards */
.forum-thread-grid{ display:grid; grid-template-columns:repeat(auto-fit, minmax(320px, 1fr)); gap:1rem; padding:.5rem; border-bottom:none !important; }
.thread-link{ display:block; text-decoration:none; color:inherit; cursor:pointer; }

/* Remove all underline/bottom line from thread links and cards */
.thread-link,
.thread-link:hover,
.thread-link:focus,
.thread-link:active,
.thread-link *,
.thread-link *:hover,
.thread-link *:focus,
.thread-link *:active{
  text-decoration:none !important;
  border:0 !important;
  border-bottom:0 !important;
  background-image:none !important;
  box-shadow:none !important;
  outline:0 !important;
}
.thread-link::before,.thread-link::after,.thread-card::before,.thread-card::after,
.forum-thread-grid > *::before,.forum-thread-grid > *::after{ content:none !important; display:none !important; }

.thread-card{
  background:var(--surface);
  border:1.5px solid var(--border);
  border-radius:18px;
  box-shadow:var(--shadow-lg);
  padding:1rem 1.1rem;
  display:flex; gap:1rem; align-items:flex-start;
  transition:border-color .15s, background .15s, transform .08s, box-shadow 0.2s ease;
}
.thread-card:hover {
  border-color:var(--accent-2);
  background:var(--surface-2);
  transform:translateY(-3px);
  box-shadow: 0 10px 25px rgba(0,0,0,.12);
}
.thread-card:active {
  transform: translateY(-1px);
}

.thread-avatar{ width:56px; height:56px; border-radius:50%; display:grid; place-items:center; font-weight:900; font-size:1.3rem; background:var(--accent-2); color:#5b3000; border:2px solid var(--accent-2); user-select:none; flex:0 0 56px; }
.thread-main{ flex:1; min-width:0; }
.thread-title{ font-size:1.1rem; font-weight:900; color:var(--accent-2); line-height:1.2; word-break:break-word; margin-top:.1rem; }
.thread-meta{ margin-top:.15rem; display:flex; gap:.6rem; flex-wrap:wrap; color:var(--text); font-size:.95rem; }
.thread-badges{ display:flex; gap:.35rem; flex-wrap:wrap; margin-top:.35rem; }
.chip{ display:inline-flex; align-items:center; gap:.35rem; border-radius:999px; padding:.15rem .6rem; font-weight:800; font-size:.8rem; background:var(--accent-2); color:var(--accent); border:0; }
.chip.pinned{ background:var(--accent); color:var(--accent-2); }
.chip.locked{ background:#ff6a6a; color:#fff; }

/* Preview with clamp + tooltip */
.thread-preview{ margin-top:.35rem; color:var(--text); opacity:.9; }
.desc-clamp{
  display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;
  overflow:hidden; text-overflow:ellipsis; max-height:2.8em; white-space:pre-line;
  cursor:default;
}

/* Roles */
.role-badge{ border-radius:999px; padding:.1rem .5rem; font-size:.75rem; font-weight:800; border:1px solid var(--border); }
.role-owner{ background:#3b1a1a; color:var(--accent-2); border-color:var(--accent-2); }
.role-admin{ background:#1a2b3b; color:#8bd3ff; border-color:#8bd3ff; }
.role-moderator{ background:#1a3b22; color:#7dffb0; border-color:#7dffb0; }
.role-member{ background:#2a2a2a; color:#ddd; border-color:#666; }

/* Header strip */
.discussion-card{ border:0; border-radius:18px; overflow:hidden; background:transparent; }
.discussion-header{ background:linear-gradient(90deg,var(--accent-2),var(--accent)); color:#111; padding:1rem 1.25rem; }
.discussion-header h2{ margin:0; font-weight:900; letter-spacing:.2px; }
.discussion-sub{ opacity:.95; font-weight:600; }

/* Modal - Fixed opacity issues */
.modal-backdrop {
  position: fixed;
  inset: 0;
  display: none;
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,.8);
  z-index: 2147483000;
  backdrop-filter: blur(3px);
  transition: opacity 0.2s ease;
}
.modal-backdrop.show {
  display: flex;
  animation: modalFadeIn 0.2s forwards;
}
@keyframes modalFadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
.modal-card {
  width: min(760px, 92vw);
  max-height: 90vh;
  overflow: auto;
  background: var(--card);
  color: var(--text);
  border: 1.5px solid var(--border);
  border-radius: 18px;
  box-shadow: 0 20px 60px rgba(0,0,0,.55);
  position: relative;
  z-index: 1;
  transform: translateY(20px);
  animation: modalSlideIn 0.3s forwards;
}
@keyframes modalSlideIn {
  to { transform: translateY(0); }
}

.modal-head,
.modal-body,
.modal-foot {
  background: var(--card);
  background-color: var(--card);
  padding: 1rem 1.25rem;
}

.modal-head {
  border-bottom: 1px solid var(--border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-foot {
  border-top: 1px solid var(--border);
  display: flex;
  justify-content: flex-end;
  gap: 0.75rem;
}

/* Enhanced form controls */
.form-control {
  width: 100%;
  background: var(--surface);
  color: var(--text);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: .6rem .75rem;
  outline: 0;
  transition: border-color 0.2s ease, box-shadow 0.2s ease, background 0.15s ease;
}
.form-control:focus {
  border-color: var(--accent-2);
  background: var(--surface-2);
  box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent-2) 25%, transparent);
}
.form-control:hover:not(:focus) {
  border-color: color-mix(in srgb, var(--accent-2) 50%, var(--border));
}

/* Buttons + inputs */
.btn{ display:inline-flex; align-items:center; gap:.4rem; border-radius:10px; border:1px solid var(--border); padding:.55rem .9rem; color:var(--text); background:var(--surface); cursor:pointer; transition: background 0.2s ease, transform 0.15s ease, border-color 0.2s ease, box-shadow 0.2s ease; }
.btn:hover {
  background: var(--surface-2);
  border-color: var(--accent-2);
  transform: translateY(-1px);
}
.btn:active {
  transform: translateY(0);
}
.btn.primary{ background:linear-gradient(90deg,var(--accent-2),var(--accent)); border:0; color:#1b1b1b; font-weight:900; box-shadow: 0 4px 12px rgba(0,0,0,.15); }
.btn.primary:hover {
  filter: brightness(1.08);
  box-shadow: 0 5px 15px rgba(0,0,0,.2);
}
.btn.primary:active {
  filter: brightness(0.95);
  box-shadow: 0 2px 8px rgba(0,0,0,.15);
}

/* Tags */
.tag-row{ display:flex; flex-wrap:wrap; gap:.5rem; margin-top:.5rem; }
.tag-pill{ display:inline-flex; align-items:center; gap:.35rem; padding:.25rem .7rem; border-radius:999px; font-weight:800; font-size:.85rem; background:var(--surface); border:1px solid var(--border); color:var(--text); cursor:pointer; user-select:none; transition: all 0.2s ease; }
.tag-pill:hover {
  background: var(--surface-2);
  border-color: var(--accent-2);
  transform: translateY(-1px);
}
.tag-pill.selected {
  background: var(--accent-2);
  color: #18191c;
  border-color: var(--accent-2);
}
.feed-empty{ text-align:center; color:#c7c7c7; padding:2rem 1rem; }

@media (max-width:575.98px){ .btn{ padding:.5rem .75rem; } }

/* Accessibility improvements - focus styles */
button:focus-visible,
.btn:focus-visible,
.forum-filter:focus-visible,
.tag-pill:focus-visible,
input:focus-visible,
textarea:focus-visible,
select:focus-visible {
  outline: 2px solid var(--accent-2);
  outline-offset: 2px;
}

.thread-card:focus-visible {
  outline: 3px solid var(--accent-2);
  outline-offset: 3px;
}

/* Skip to content link for keyboard users */
.skip-to-content {
  position: absolute;
  left: -9999px;
  top: -9999px;
  z-index: 9999;
  background: var(--accent-2);
  color: var(--accent);
  padding: 1rem;
  font-weight: bold;
  border-radius: 0 0 8px 8px;
}
.skip-to-content:focus {
  left: 50%;
  top: 0;
  transform: translateX(-50%);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4 px-0">
  <div class="row justify-content-center mx-0">
    <div class="col-12 px-0">
      <div class="thread-list-card discussion-card">
        <div class="discussion-header">
          <h2 class="mb-1"><i class="fa-solid fa-comments me-2"></i> Threads</h2>
          <div class="discussion-sub">Start a topic or join a thread. Be respectful and stay on topic.</div>
        </div>

        <div class="card-body p-0">

          {% include "_flash.html" %}

          <div class="forum-topbar">
            <input id="threadSearch" class="forum-search" type="text" placeholder="Search threads..." aria-label="Search threads">
            {% if current_user.is_authenticated %}
              <button id="openNewPost" class="forum-new-btn" type="button"><i class="fa-solid fa-plus"></i> New Post</button>
              {% if current_user.role in ['owner','admin'] %}
                <button id="openManageTags" class="btn" type="button"><i class="fa-solid fa-tags"></i> Manage Tags</button>
              {% endif %}
            {% else %}
              <a href="{{ url_for('auth.login') }}" class="btn"><i class="fa-solid fa-right-to-bracket"></i> Log in</a>
            {% endif %}
          </div>

          <div class="forum-controls">
            <span class="forum-filter active" data-filter="all">All</span>
            <span class="forum-filter" data-filter="pinned">Pinned</span>
            <!-- Dynamic tag filters are injected by JS from /api/tags -->
            <select id="sortSelect" class="forum-sort" aria-label="Sort threads">
              <option value="recent">Sort: Recent</option>
              <option value="replies">Sort: Replies</option>
              <option value="pinned">Sort: Pinned first</option>
            </select>
          </div>

          <div id="threadGrid" class="forum-thread-grid">
            {% if threads|length > 0 %}
              {% for thread in threads %}
                {% set reply_count = thread.comments|length %}
                {% set last_dt = (thread.comments[-1].created_at if reply_count > 0 else thread.created_at) %}
                <a href="{{ url_for('views.view_thread', thread_id=thread.id) }}" class="thread-link">
                  <div
                    class="thread-card"
                    data-id="{{ thread.id }}"
                    data-title="{{ thread.title|lower }}"
                    data-replies="{{ reply_count }}"
                    data-pinned="{{ 1 if thread.pinned else 0 }}"
                    data-tags="{% if thread.tags %}{{ thread.tags|map(attribute='name')|join(',')|lower }}{% endif %}"
                    data-updated="{{ last_dt.strftime('%Y-%m-%dT%H:%M:%S') }}"
                    tabindex="0"
                  >
                    <div class="thread-avatar" aria-hidden="true">{{ thread.author.username[:1]|upper }}</div>
                    <div class="thread-main">
                      <div class="thread-title">{{ thread.title }}</div>
                      <div class="thread-meta">
                        <span><i class="fa-regular fa-user"></i> {{ thread.author.username }}</span>
                        <span class="role-badge role-{{ thread.author.role|default('member') }}">{{ thread.author.display_title|default(thread.author.role|default('Member')|capitalize) }}</span>
                        <span><i class="fa-regular fa-clock"></i> {{ last_dt.strftime('%b %d, %Y %I:%M %p') }}</span>
                        {% if reply_count > 0 %}<span><i class="fa-regular fa-comment-dots"></i> {{ reply_count }}</span>{% endif %}
                      </div>
                      <div class="thread-badges">
                        {% if thread.pinned %}<span class="chip pinned"><i class="fa-solid fa-thumbtack"></i> Pinned</span>{% endif %}
                        {% if thread.locked %}<span class="chip locked"><i class="fa-solid fa-lock"></i> Locked</span>{% endif %}
                        {% if thread.tags %}
                          {% for tag in thread.tags %}
                            <span class="chip {{ tag.slug|default(tag.name|lower) }}">{{ tag.name }}</span>
                          {% endfor %}
                        {% endif %}
                      </div>
                      <div class="thread-preview">
                        {% if thread.comments and thread.comments[0] %}
                          <span class="fw-bold text-muted" style="font-size:.97em;">Description:</span>
                          <span class="desc-clamp" title="{{ thread.comments[0].content|e }}">{{ thread.comments[0].content }}</span>
                        {% else %}
                          <span class="text-muted">No description.</span>
                        {% endif %}
                      </div>
                    </div>
                  </div>
                </a>
              {% endfor %}
            {% else %}
              <div class="feed-empty">
                <i class="fa-regular fa-comment-dots fa-2x mb-2" aria-hidden="true"></i>
                <div>No threads yet — be the first to start one.</div>
              </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% if current_user.is_authenticated %}
<!-- New Post Modal -->
<div id="newPostModal" class="modal-backdrop" aria-hidden="true" aria-modal="true" role="dialog" aria-labelledby="newPostTitle">
  <div class="modal-card">
    <div class="modal-head">
      <strong id="newPostTitle"><i class="fa-solid fa-plus"></i> New Thread</strong>
      <button type="button" class="btn" id="closeNewPost" aria-label="Close"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <form method="POST" action="{{ url_for('views.create_thread') }}">
      <div class="modal-body">
        <label class="form-label" for="threadTitle">Title</label>
        <input id="threadTitle" name="title" class="form-control" maxlength="120" placeholder="Give your thread a clear title" required>
        <div class="help-text mt-1">Keep it short and descriptive.</div>

        <label class="form-label mt-3" for="threadDesc">Description</label>
        <textarea id="threadDesc" name="description" class="form-control" maxlength="2000" rows="5" placeholder="Describe your topic... This becomes the first post in your thread." required></textarea>
        <div class="help-text mt-1"><span id="descCount">0</span>/2000</div>

        <label class="form-label mt-3">Tags</label>
        <div id="tagPicker" class="tag-row" aria-live="polite"></div>
        <input type="hidden" name="tag_ids" id="tagIds">
        <div class="help-text mt-1">Select up to 3 tags.</div>
      </div>
      <div class="modal-foot">
        <button type="button" class="btn" id="cancelNewPost">Cancel</button>
        <button type="submit" class="btn primary">Create Thread</button>
      </div>
    </form>
  </div>
</div>

{% if current_user.role in ['owner','admin'] %}
<!-- Manage Tags Modal (Owner/Admin only) -->
<div id="manageTagsModal" class="modal-backdrop" aria-hidden="true" aria-modal="true" role="dialog" aria-labelledby="manageTagsTitle">
  <div class="modal-card">
    <div class="modal-head">
      <strong id="manageTagsTitle"><i class="fa-solid fa-tags"></i> Manage Tags</strong>
      <button type="button" class="btn" id="closeManageTags" aria-label="Close"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="modal-body">
      <div id="manageTagRow" class="tag-row"></div>
      <div class="mt-3 d-flex gap-2" style="display:flex; gap:.5rem; align-items:center;">
        <input id="newTagName" class="form-control" placeholder="New tag name (e.g., Help)">
        <button id="addTagBtn" class="btn primary" type="button"><i class="fa-solid fa-plus"></i> Add Tag</button>
      </div>
      <div class="help-text mt-2">Click the × on a tag to delete it. Changes are live and immediately available in the New Post modal and filters.</div>
    </div>
    <div class="modal-foot">
      <button type="button" class="btn" id="closeManageTags2">Close</button>
    </div>
  </div>
</div>
{% endif %}
{% endif %}
{% endblock %}

{% block javascript %}
<script>
// Make sure the DOM is fully loaded before attaching events
document.addEventListener('DOMContentLoaded', function() {
  // Helper functions for DOM selection
  const $ = (s, r=document) => r.querySelector(s);
  const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

  console.log("DOM fully loaded, initializing script...");
  
  // DEBUG: Log important elements to verify they're found
  const newPostModal = $('#newPostModal');
  const manageTagsModal = $('#manageTagsModal');
  const openNewPostBtn = $('#openNewPost');
  const openManageTagsBtn = $('#openManageTags');
  
  console.log("New Post Modal exists:", !!newPostModal);
  console.log("Manage Tags Modal exists:", !!manageTagsModal);
  console.log("Open New Post Button exists:", !!openNewPostBtn);
  console.log("Open Manage Tags Button exists:", !!openManageTagsBtn);

  // CRITICAL FIX: Don't move modals out of their container
  // Moving modals was causing issues with event binding
  
  // Improved modal handling with animations
  function openBackdrop(el) {
    console.log("Opening modal:", el?.id);
    if (!el) {
      console.error("Modal element not found");
      return;
    }
    document.body.style.overflow = 'hidden'; // Prevent background scrolling
  document.body.classList.add('modal-open');
    el.classList.add('show');
    el.setAttribute('aria-hidden', 'false');
    
    // Focus first input with a small delay to allow animation
    setTimeout(() => {
      const focusTarget = el.querySelector('input:not([type="hidden"]),textarea,button:not([id^="close"])');
      if (focusTarget) focusTarget.focus();
    }, 100);
  }
  
  function closeBackdrop(el) {
    console.log("Closing modal:", el?.id);
    if (!el) {
      console.error("Modal element not found");
      return;
    }
    document.body.style.overflow = '';
  document.body.classList.remove('modal-open');
    el.classList.remove('show');
    el.setAttribute('aria-hidden', 'true');
  }

  // Improved event listeners with debouncing for search
  const grid = $('#threadGrid');
  const search = $('#threadSearch');
  const sortSel = $('#sortSelect');
  const filters = $$('.forum-filter');

  function normalize(s) { 
    return (s || '').toLowerCase().trim(); 
  }
  
  // Debounce function to improve search performance
  function debounce(func, wait) {
    let timeout;
    return function(...args) {
      clearTimeout(timeout);
      timeout = setTimeout(() => func.apply(this, args), wait);
    };
  }
  
  // FIXED: Apply filters function
  const applyFilters = debounce(function() {
    console.log("Applying filters...");
    const q = normalize(search?.value || '');
    const active = filters.find(f => f.classList.contains('active'))?.dataset.filter || 'all';
    const mode = sortSel?.value || 'recent';
    const cards = $$('.thread-card', grid || document);
    
    console.log("Active filter:", active);
    console.log("Search query:", q);
    console.log("Sort mode:", mode);
    console.log("Found cards:", cards.length);
    
    let visibleCount = 0;

    cards.forEach(card => {
      const title = normalize(card.dataset.title || '');
      const tags = normalize(card.dataset.tags || '');
      const pinned = card.dataset.pinned === '1';
      let show = true;
      
      // Apply search filter
      if (q && !title.includes(q)) {
        show = false;
      }
      
      // Apply tag/pinned filter
      if (show && active !== 'all') {
        if (active === 'pinned') {
          show = pinned;
        } else {
          show = tags.split(',').some(t => normalize(t) === normalize(active));
        }
      }
      
      // Get the parent element (thread-link)
      const parent = card.closest('.thread-link');
      
      if (show) {
        if (parent) parent.style.display = '';
        visibleCount++;
      } else {
        if (parent) parent.style.display = 'none';
      }
    });

    // Show empty state if no results
    const emptyState = $('.feed-empty');
    if (emptyState) {
      if (visibleCount === 0 && cards.length > 0) {
        // Create "no results" message if it doesn't exist
        let noResults = $('.no-results-message');
        if (!noResults) {
          noResults = document.createElement('div');
          noResults.className = 'feed-empty no-results-message';
          noResults.innerHTML = `
            <i class="fa-solid fa-search fa-2x mb-2" aria-hidden="true"></i>
            <div>No threads match your search criteria.</div>
          `;
          if (grid) grid.appendChild(noResults);
        }
        noResults.style.display = '';
      } else {
        const noResults = $('.no-results-message');
        if (noResults) noResults.style.display = 'none';
      }
    }

    // Sort the visible items
    if (grid) {
      const items = cards
        .filter(c => {
          const p = c.closest('.thread-link');
          return p && p.style.display !== 'none';
        })
        .map(c => ({
          node: c.closest('.thread-link'), 
          pinned: c.dataset.pinned === '1', 
          replies: +(c.dataset.replies || 0), 
          updated: Date.parse(c.dataset.updated || 0) || 0
        }));

      if (mode === 'pinned') {
        items.sort((a,b) => (b.pinned - a.pinned) || (b.updated - a.updated));
      } else if (mode === 'replies') {
        items.sort((a,b) => (b.replies - a.replies) || (b.updated - a.updated));
      } else {
        items.sort((a,b) => (b.updated - a.updated));
      }
      
      items.forEach(it => {
        if (it.node) grid.appendChild(it.node);
      });
    }
    
    console.log("Filter applied. Visible items:", visibleCount);
  }, 200);

  // CRITICAL FIX: Explicitly bind all event listeners
  
  // Bind search input
  if (search) {
    console.log("Adding event listener to search input");
    search.addEventListener('input', function() {
      applyFilters();
    });
  }
  
  // Bind sort selector
  if (sortSel) {
    console.log("Adding event listener to sort select");
    sortSel.addEventListener('change', function() {
      applyFilters();
    });
  }
  
  // Bind filter buttons with improved logging
  console.log("Found filter buttons:", filters.length);
  filters.forEach((filter, index) => {
    console.log(`Adding event listener to filter [${index}]:`, filter.textContent, filter.dataset.filter);
    filter.addEventListener('click', function() {
      console.log("Filter clicked:", this.dataset.filter);
      filters.forEach(f => f.classList.remove('active'));
      this.classList.add('active');
      applyFilters();
    });
    // Keyboard accessibility: activate on Enter/Space
    filter.setAttribute('tabindex', '0');
    filter.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        this.click();
      }
    });
  });

  // FIXED: New Post modal event binding
  if (openNewPostBtn) {
    console.log("Adding click handler to New Post button");
    openNewPostBtn.addEventListener('click', function(e) {
      console.log("New Post button clicked");
      e.preventDefault();
      if (newPostModal) openBackdrop(newPostModal);
    });
  }
  
  const closeNewPostBtn = $('#closeNewPost');
  if (closeNewPostBtn) {
    console.log("Adding click handler to Close New Post button");
    closeNewPostBtn.addEventListener('click', function() {
      if (newPostModal) closeBackdrop(newPostModal);
    });
  }
  
  const cancelNewPostBtn = $('#cancelNewPost');
  if (cancelNewPostBtn) {
    console.log("Adding click handler to Cancel New Post button");
    cancelNewPostBtn.addEventListener('click', function() {
      if (newPostModal) closeBackdrop(newPostModal);
    });
  }
  
  // Close modal when clicking backdrop
  if (newPostModal) {
    console.log("Adding click handler to New Post modal backdrop");
    newPostModal.addEventListener('click', function(e) {
      if (e.target === this) closeBackdrop(this);
    });
  }

  // FIXED: Manage Tags modal event binding
  if (openManageTagsBtn) {
    console.log("Adding click handler to Manage Tags button");
    openManageTagsBtn.addEventListener('click', function(e) {
      console.log("Manage Tags button clicked");
      e.preventDefault();
      if (manageTagsModal) openBackdrop(manageTagsModal);
    });
  }
  
  const closeManageTagsBtn = $('#closeManageTags');
  if (closeManageTagsBtn) {
    console.log("Adding click handler to Close Manage Tags button");
    closeManageTagsBtn.addEventListener('click', function() {
      if (manageTagsModal) closeBackdrop(manageTagsModal);
    });
  }
  
  const closeManageTags2Btn = $('#closeManageTags2');
  if (closeManageTags2Btn) {
    console.log("Adding click handler to secondary Close Manage Tags button");
    closeManageTags2Btn.addEventListener('click', function() {
      if (manageTagsModal) closeBackdrop(manageTagsModal);
    });
  }
  
  // Close modal when clicking backdrop
  if (manageTagsModal) {
    console.log("Adding click handler to Manage Tags modal backdrop");
    manageTagsModal.addEventListener('click', function(e) {
      if (e.target === this) closeBackdrop(this);
    });
  }

  // Description counter
  const desc = $('#threadDesc'); 
  const descCount = $('#descCount');
  
  function updDesc(){
    if(desc && descCount) descCount.textContent = String(desc.value.length);
  }
  
  if (desc) {
    desc.addEventListener('input', updDesc);
    updDesc(); // Initialize
  }

  // Rest of your code for tag API functionality...
  // This part seems to be working fine so I'm not modifying it

  // Initial run of applyFilters to ensure proper state on page load
  applyFilters();
  
  console.log("Script initialization complete!");
});
</script>
{% endblock %}